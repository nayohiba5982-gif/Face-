<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Face & rPPG Data Collector</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f2f5; }
    #container { position: relative; width: 640px; height: 480px; margin: 10px auto; border: 5px solid #fff; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow: hidden; }
    video, canvas { position: absolute; top: 0; left: 0; transform: scaleX(-1); }
    .controls { margin: 20px; padding: 20px; background: white; display: inline-block; border-radius: 10px; }
    button { padding: 10px 25px; font-size: 16px; cursor: pointer; border-radius: 5px; border: none; transition: 0.3s; }
    #startBtn { background: #28a745; color: white; }
    #stopBtn { background: #dc3545; color: white; display: none; }
    input { padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; width: 120px; margin: 5px; }
    #status { margin-top: 10px; font-weight: bold; color: #555; }
    /* çµŒéæ™‚é–“è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #timer { font-size: 24px; color: #dc3545; margin-bottom: 10px; font-weight: bold; display: none; }
  </style>
</head>
<body>
  <h1>Data Collector</h1>

  <div class="controls">
    <div id="timer">00.0s</div> <input type="password" id="passCode" placeholder="Password">
    <input type="text" id="userID" placeholder="User_ID">
    <br>
    <button id="startBtn">è¨ˆæ¸¬é–‹å§‹</button>
    <button id="stopBtn">è¨ˆæ¸¬çµ‚äº† & é€ä¿¡</button>
    <div id="status">æº–å‚™ä¸­...</div>
  </div>

  <div id="container">
    <video id="input_video"></video>
    <canvas id="output_canvas" width="640px" height="480px"></canvas>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycby0dWkUb06_85_P2TO-RuocPjgYSsW3KtJ7UXKzFnrcSs6fmHjOxVhWzHfWz2x8PaRD/exec";
    const SECRET_PASS = "team123"; 

    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d', {willReadFrequently: true});
    const statusElement = document.getElementById('status');
    const timerElement = document.getElementById('timer'); // ã‚¿ã‚¤ãƒãƒ¼è¦ç´ 
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const userIDInput = document.getElementById('userID');
    const passInput = document.getElementById('passCode');

    let isRecording = false;
    let recordedData = [];
    let startTime = 0; // é–‹å§‹æ™‚é–“ä¿æŒç”¨

    const ROI_LANDMARKS = {
      forehead: [10, 151, 9],
      rightCheek: [117, 118, 101],
      leftCheek: [347, 348, 330]
    };

    function onResults(results) {
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

      if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
        const landmarks = results.multiFaceLandmarks[0];
        
        // çµŒéæ™‚é–“ã®è¨ˆç®—ã¨è¡¨ç¤º
        if (isRecording) {
          const elapsed = (Date.now() - startTime) / 1000;
          timerElement.innerText = elapsed.toFixed(1) + "s";
          statusElement.innerText = "â— è¨ˆæ¸¬ä¸­...";
        } else {
          statusElement.innerText = "æº–å‚™å®Œäº†";
        }

        const foreheadColor = getAverageColorOfPoints(landmarks, ROI_LANDMARKS.forehead);
        const rCheekColor = getAverageColorOfPoints(landmarks, ROI_LANDMARKS.rightCheek);
        const lCheekColor = getAverageColorOfPoints(landmarks, ROI_LANDMARKS.leftCheek);

        drawGuide(landmarks);

        if (isRecording) {
          recordedData.push({
            time: Date.now(),
            landmarks: landmarks.slice(0, 106).map(l => ({x: l.x, y: l.y, z: l.z})), 
            rppg: { forehead: foreheadColor, right: rCheekColor, left: lCheekColor }
          });
        }
      } else {
        statusElement.innerText = "é¡”ã‚’èªè­˜ã§ãã¾ã›ã‚“";
      }
      canvasCtx.restore();
    }

    function getAverageColorOfPoints(landmarks, indices) {
      let r = 0, g = 0, b = 0;
      const sampleSize = 5;
      indices.forEach(idx => {
        const point = landmarks[idx];
        const x = Math.floor((1 - point.x) * canvasElement.width);
        const y = Math.floor(point.y * canvasElement.height);
        const imageData = canvasCtx.getImageData(x - 2, y - 2, sampleSize, sampleSize).data;
        let pr = 0, pg = 0, pb = 0;
        for (let i = 0; i < imageData.length; i += 4) {
          pr += imageData[i]; pg += imageData[i + 1]; pb += imageData[i + 2];
        }
        r += pr / (imageData.length / 4);
        g += pg / (imageData.length / 4);
        b += pb / (imageData.length / 4);
      });
      return { r: Math.round(r / indices.length), g: Math.round(g / indices.length), b: Math.round(b / indices.length) };
    }

    function drawGuide(landmarks) {
      canvasCtx.fillStyle = "rgba(0, 255, 0, 0.5)";
      [...ROI_LANDMARKS.forehead, ...ROI_LANDMARKS.rightCheek, ...ROI_LANDMARKS.leftCheek].forEach(idx => {
        const p = landmarks[idx];
        canvasCtx.fillRect((1 - p.x) * canvasElement.width - 3, p.y * canvasElement.height - 3, 6, 6);
      });
    }

    const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
    
    // --- ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šã®å¤‰æ›´ ---
    faceMesh.setOptions({ 
      maxNumFaces: 1, 
      refineLandmarks: true, 
      minDetectionConfidence: 0.5,
      minFacePresenceConfidence: 0.5 // â†ã“ã“ã«è¿½åŠ ï¼
    });
    
    faceMesh.onResults(onResults);

    const camera = new Camera(videoElement, {
      onFrame: async () => { await faceMesh.send({image: videoElement}); },
      width: 640, height: 480
    });
    camera.start();

    startBtn.onclick = () => {
      if(passInput.value !== SECRET_PASS) { alert("åˆè¨€è‘‰ãŒé•ã„ã¾ã™"); return; }
      if(!userIDInput.value) { alert("è¢«é¨“è€…IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      
      isRecording = true;
      startTime = Date.now(); // é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²
      recordedData = [];
      
      startBtn.style.display = "none";
      stopBtn.style.display = "inline-block";
      timerElement.style.display = "block"; // ã‚¿ã‚¤ãƒãƒ¼ã‚’è¡¨ç¤º
    };

    stopBtn.onclick = async () => {
      isRecording = false;
      timerElement.style.display = "none"; // é€ä¿¡æ™‚ã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’éš ã™
      
      statusElement.innerText = "â³ ãƒ‡ãƒ¼ã‚¿ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™...";
      stopBtn.disabled = true;
      stopBtn.style.opacity = "0.5";

      const payload = {
        userID: userIDInput.value,
        points: recordedData
      };

      statusElement.innerText = "ğŸš€ é€ä¿¡ä¸­... ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„";

      try {
        await fetch(GAS_URL, {
          method: "POST",
          mode: "no-cors",
          body: JSON.stringify(payload)
        });

        statusElement.innerText = "âœ… é€ä¿¡æˆåŠŸï¼";
        statusElement.style.color = "#28a745";
        alert("ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼");
        location.reload(); 

      } catch (e) {
        console.error(e);
        statusElement.innerText = "âŒ é€ä¿¡å¤±æ•—ã€‚";
        statusElement.style.color = "#dc3545";
        alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        stopBtn.disabled = false;
        stopBtn.style.opacity = "1";
      }
    };
  </script>
</body>
</html>
