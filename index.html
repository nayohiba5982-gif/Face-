<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Face & rPPG Data Collector</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f2f5; }
    #container { position: relative; width: 640px; height: 480px; margin: 10px auto; border: 5px solid #fff; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow: hidden; }
    video, canvas { position: absolute; top: 0; left: 0; transform: scaleX(-1); }
    .controls { margin: 20px; padding: 20px; background: white; display: inline-block; border-radius: 10px; }
    button { padding: 10px 25px; font-size: 16px; cursor: pointer; border-radius: 5px; border: none; transition: 0.3s; }
    #startBtn { background: #28a745; color: white; }
    #stopBtn { background: #dc3545; color: white; display: none; }
    input { padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; width: 120px; margin: 5px; }
    #status { margin-top: 10px; font-weight: bold; color: #555; }
  </style>
</head>
<body>
  <h1>顔データ収集システム</h1>

  <div class="controls">
    <input type="password" id="passCode" placeholder="合言葉">
    <input type="text" id="userID" placeholder="被験者ID">
    <input type="text" id="userName" placeholder="担当者名">
    <br>
    <button id="startBtn">計測開始</button>
    <button id="stopBtn">計測終了 & 送信</button>
    <div id="status">準備中...</div>
  </div>

  <div id="container">
    <video id="input_video"></video>
    <canvas id="output_canvas" width="640px" height="480px"></canvas>
  </div>

  <script>
    // --- 設定 ---
    const GAS_URL = "https://script.google.com/macros/s/AKfycby0dWkUb06_85_P2TO-RuocPjgYSsW3KtJ7UXKzFnrcSs6fmHjOxVhWzHfWz2x8PaRD/exec";
    const SECRET_PASS = "team123"; // ここをチームの合言葉に変えてください

    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d', {willReadFrequently: true});
    const statusElement = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const userNameInput = document.getElementById('userName');
    const userIDInput = document.getElementById('userID');
    const passInput = document.getElementById('passCode');

    let isRecording = false;
    let recordedData = [];

    const ROI_LANDMARKS = {
      forehead: [10, 151, 9],
      rightCheek: [117, 118, 101],
      leftCheek: [347, 348, 330]
    };

    function onResults(results) {
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

      if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
        const landmarks = results.multiFaceLandmarks[0];
        statusElement.innerText = isRecording ? "● 計測中..." : "準備完了";

        const foreheadColor = getAverageColorOfPoints(landmarks, ROI_LANDMARKS.forehead);
        const rCheekColor = getAverageColorOfPoints(landmarks, ROI_LANDMARKS.rightCheek);
        const lCheekColor = getAverageColorOfPoints(landmarks, ROI_LANDMARKS.leftCheek);

        drawGuide(landmarks);

        if (isRecording) {
          recordedData.push({
            time: Date.now(),
            landmarks: landmarks.slice(0, 106), 
            rppg: { forehead: foreheadColor, right: rCheekColor, left: lCheekColor }
          });
        }
      } else {
        statusElement.innerText = "顔を認識できません";
      }
      canvasCtx.restore();
    }

    function getAverageColorOfPoints(landmarks, indices) {
      let r = 0, g = 0, b = 0;
      const sampleSize = 5;
      indices.forEach(idx => {
        const point = landmarks[idx];
        const x = Math.floor((1 - point.x) * canvasElement.width);
        const y = Math.floor(point.y * canvasElement.height);
        const imageData = canvasCtx.getImageData(x - 2, y - 2, sampleSize, sampleSize).data;
        let pr = 0, pg = 0, pb = 0;
        for (let i = 0; i < imageData.length; i += 4) {
          pr += imageData[i]; pg += imageData[i + 1]; pb += imageData[i + 2];
        }
        r += pr / (imageData.length / 4);
        g += pg / (imageData.length / 4);
        b += pb / (imageData.length / 4);
      });
      return { r: Math.round(r / indices.length), g: Math.round(g / indices.length), b: Math.round(b / indices.length) };
    }

    function drawGuide(landmarks) {
      canvasCtx.fillStyle = "rgba(0, 255, 0, 0.5)";
      [...ROI_LANDMARKS.forehead, ...ROI_LANDMARKS.rightCheek, ...ROI_LANDMARKS.leftCheek].forEach(idx => {
        const p = landmarks[idx];
        canvasCtx.fillRect((1 - p.x) * canvasElement.width - 3, p.y * canvasElement.height - 3, 6, 6);
      });
    }

    // --- MediaPipeの初期化 (ここが重要！) ---
    const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
    faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5 });
    faceMesh.onResults(onResults);

    const camera = new Camera(videoElement, {
      onFrame: async () => { await faceMesh.send({image: videoElement}); },
      width: 640, height: 480
    });
    camera.start();

    // --- ボタンイベント ---
    startBtn.onclick = () => {
      if(passInput.value !== SECRET_PASS) { alert("合言葉が違います"); return; }
      if(!userIDInput.value || !userNameInput.value) { alert("IDと名前を入力してください"); return; }
      isRecording = true;
      recordedData = [];
      startBtn.style.display = "none";
      stopBtn.style.display = "inline-block";
    };

    stopBtn.onclick = async () => {
      isRecording = false;
      statusElement.innerText = "データを送信中...（数秒かかります）";
      stopBtn.disabled = true;

      const payload = {
        userID: userIDInput.value,
        userName: userNameInput.value,
        points: recordedData
      };

      try {
        await fetch(GAS_URL, {
          method: "POST",
          mode: "no-cors", // GASへの簡易送信
          body: JSON.stringify(payload)
        });
        statusElement.innerText = "送信完了！ブラウザを閉じてOKです。";
      } catch (e) {
        statusElement.innerText = "エラー発生。通信環境を確認してください。";
        stopBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
